---
output: pdf_document
---
```{r}
# municipal scores
saeb_student_mun <- fread(
  here("data/saeb/saeb_student.csv.gz")
) %>% 
  filter(
    subject == "l"
  ) %>% 
  group_by(
    cod_ibge_6,
    year
  ) %>% 
  summarise(
    mean_score = mean(grade_exam, na.rm = T)
  ) %>% 
  ungroup()

mayor <- fread(
  here("data/tse/mayor.csv")
)

# accountability estimation
saeb_election <- saeb_student_mun %>% 
  mutate(
    election_year = case_when(
      between(year, 2001, 2003) ~ 2000,
      between(year, 2005, 2007) ~ 2004,
      between(year, 2009, 2011) ~ 2008,
      between(year, 2013, 2015) ~ 2012
    )
  ) %>% 
  group_by(
    cod_ibge_6,
    election_year
  ) %>% 
  summarise(
    mean_score = mean(mean_score, na.rm = T)
  ) %>% 
  mutate(
    mean_score_lag_1 = dplyr::lag(mean_score, 1, order_by = election_year),
    mean_score_lag_2 = dplyr::lag(mean_score, 2, order_by = election_year),
    delta_mean_score = (mean_score_lag_1 - mean_score_lag_2)/mean_score_lag_2
  ) %>% 
  ungroup()

accountability <- mayor %>% 
  group_by(
    cpf_candidate
  ) %>% 
  arrange(
    desc(election_year)
  ) %>% 
  mutate(
    vote_lag = dplyr::lag(vote, order_by = election_year)
  ) %>% 
  ungroup() %>% 
  group_by(
    cod_ibge_6,
    election_year
  ) %>% 
  mutate(
    total_vote = sum(vote, na.rm = T),
    n_candidate = n()
  ) %>% 
  ungroup() %>% 
  filter(
    incumbent == 1,
    n_candidate > 1 # drop elections with only 1 candidate
  ) %>% 
  left_join(
    saeb_election,
    by = c("cod_ibge_6", "election_year")
  ) %>% 
  mutate(
    state = str_sub(cod_ibge_6, 1, 2),
    election_year = as.factor(election_year),
    gender = if_else(gender == 2, "male", "female"),
    elected = if_else(outcome == "eleito", 1, 0),
    vote_share = vote/total_vote*100
  )
```

## Introduction

In this chapter, I focus on the final link in the causal mechanism of my theory: does improving the quality of public services (education) reward politicians electorally? If so, a key assumption of the model is confirmed: good performance in the first term rewards incumbents with reelection. The empirical test presented here builds on an extensive data collection process, done in active collaboration with Matheus Soldi Hardt from the University of SÃ£o Paulo.

Merging this educational dataset with electoral outcomes, I provide an empirical test of whether incumbent politicians are more likely to stay in office when improvements in educational services occurs. This builds on a growing literature on electoral accountability and public service provision in the developing world.^[@boas_electoral_2019, @boas_norms_2019, @ashworth_electoral_2012.] There are good reasons to be skeptical of that final link. The empirical record has been decidedly mixed: while some studies suggest that electoral incentives reduce corruption and boost economic growth (@ferraz_electoral_2011, @besley_does_1995), others have found that providing voters with information on incumbent performance (positive or negative) has no effect in changing electoral outcomes (@boas_electoral_2019, @boas_norms_2019).

I find confirmation that indeed
Before starting my empirical analysis, I review the relevant literature on the topic of electoral accountability and its intersection with public goods provision.

## From clientelism to electoral (un)accountability

Starting with @barro_control_1973, political economists have sought to model how reelection as an institutional feature can potentially induce "good" behavior by politicians. The key feature in these models is a sequential structure and a principal-agent dynamic, where the possibility of reelection motivates office-minded politicians (agents) to provide in their first term the public goods voters (principals) desire, and be rewarded by retaining their office for the second term.^[For an extensive treatment, see @besley_principled_2006.]

With few exceptions, much of this electoral accountability work has remained purely theoretical, with sparse empirical test of their propositions.^[@besley_incumbent_1992, @ferraz_electoral_2011.] Particularly salient is a lack of validation in the context of the developing world, where the predominant mode of analyzing electoral dynamics is through the theoretical lens of clientelism.^[@wantchekon_clientelism_2003, @stokes_brokers_2013.] There are subtle but important differences between these two analytical frameworks worth highlighting before delving into empirical analysis.

Scholars engaging with the problematic of clientelism are principally concerned with patron-client relations.^[@scott_patron-client_1972, @hicken_clientelism_2011.] In particular, the analytical focus is on who gets what in the act of redistribution by a politician (patron) to voters (clients). Debates on the quality of public goods is incidental, at times noting that the allocation of patronage can have a detrimental effect on public goods provision.^[@robinson_political_2013.] A narrow focus on these clientelistic relationships forecloses the analysis of electoral accountability through performance: as long as a sufficient mass of voters are bought-off by a politician, she secures reelection.^[@dixit_determinants_1996.]

The repertoire of strategies for reelection, particularly for incumbents, goes far beyond private transactions between brokers or clients. Some scholars have problematized the distinction between public and private goods outlined in @stokes_brokers_2013, arguing that politicians often engage in a mix of both.^[@min_power_2015.] For instance, @magaloni_clientelism_2007 argues that politicians can diversify their portfolio of public and private goods distribution in order to minimize the risk of each strategy, drawing from financial theories of portfolio allocation, with an empirical test in Mexico. More starkly, @lizzeri_provision_2001 model how politicians opt for either public goods provision or vote-buying according to electoral rules.

Empirically, it is clear that voters are not only bought off, but also care about public goods provision.^[@kaufman_globalization_2001.] The question is if improvements in the delivery of these goods have an effect on the incumbent's probability of reelection. Models of electoral accountability are often focused on comparative statics: does improving the information environment or introducing term limits induce changes in incumbent behavior?^[@ashworth_electoral_2012, @snyder_press_2010. For the effect of term limits, @ferraz_electoral_2011, @besley_does_1995, @besley_political_2003.] Our question is both narrow and foundational: does exerting effort to improve education improve reelection prospects?

## Measuring performance

As outlined in chapter X, there is significant intermunicipal and intertemporal variation in test scores. We illustrate these trends by randomly sampling ten municipalities and plotting the change in municipal average test scores across time. There is a clear serial correlation, as well as an upward trend in municipal average test scores. 

```{r}
saeb_student_mun %>% 
  nest(-cod_ibge_6) %>% 
  sample_n(20) %>% 
  unnest() %>% 
  mutate(
    cod_ibge_6 = as.factor(cod_ibge_6)
  ) %>% 
  ggplot(
    aes(
      year,
      mean_score,
      group = cod_ibge_6
    )
  ) +
  geom_point(
    color = "coral3"
  ) +
  geom_line(
    color = "coral3"
  ) +
  geom_vline(
    xintercept = seq(2009, 2013, 4),
    linetype = "dashed",
    color = "grey65"
  ) +
  theme(
    legend.position = "none"
  ) + 
  ggtitle(
    "Annual variation in municipal test scores:\n random sample"
  )
```

The goal of the estimation is to capture the effect of inter-term changes in education test scores on the probability of the incumbent being reelected. Given these conditions, I opt for a first-differences approach to estimate the change in vote share of the incumbent as a result of changes in the educational performance during her mandate.

\footnotesize

```{r, results = "asis"}
fit_acc <- list()

fit_acc$lm <- lm(
  vote_share ~ log(mean_score_lag_1),
  data = accountability
)
  
fit_acc$fe <- felm(
  vote_share ~ log(mean_score_lag_1)| election_year + state | 0 | cod_ibge_6,
  data = accountability
)

fit_acc$fe_full <- felm(
  vote_share ~ log(mean_score_lag_1) + edu + as.factor(party) + as.factor(gender) + times_office| election_year + state | 0 | cod_ibge_6,
  data = accountability
)

stargazer::stargazer(
  fit_acc$lm,
  fit_acc$fe,
  fit_acc$fe_full,
  title = "Linear Regression",
  omit = c("Constant", "as.factor"),
  header = F,
  single.row = T,
  omit.stat = "F"
)
```

```{r, results = "asis"}
fit_acc_2 <- list()

fit_acc_2$glm <- glm(
  elected ~ log(mean_score_lag_1),
  data = accountability,
  family = "binomial"
)
  
fit_acc_2$glm_fe <- glm(
  elected ~ log(mean_score_lag_1) + election_year + as.factor(state),
  data = accountability,
  family = "binomial"
)

fit_acc_2$glm_fe_full <- glm(
  elected ~ log(mean_score_lag_1) + + edu + as.factor(party) + as.factor(gender) + times_office +
    as.factor(election_year) + as.factor(state),
  data = accountability,
  family = "binomial"
)

stargazer::stargazer(
  fit_acc_2$glm,
  fit_acc_2$glm_fe,
  fit_acc_2$glm_fe_full,
  title = "Logistic Regression",
  omit = c("Constant", "as.factor"),
  header = F,
  single.row = T,
  omit.stat = "F"
)
```

```{r}
clean
```

